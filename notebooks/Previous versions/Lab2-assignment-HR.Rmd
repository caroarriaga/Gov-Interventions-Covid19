---
title: "Lab 2: Impact of Government Interventions on COVID-19 deaths"
author: "Carolina Arriaga, Sunit Carpenter, Heather Rancic"
output: 
  html_document: default
 # bookdown::pdf_document2:
  toc: true
---

\clearpage

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)
```


```{r libraries, echo=FALSE, warning=FALSE, message=FALSE}
options(repos="https://cran.rstudio.com" )

library(usmap)
# library(readxl)
library(stargazer)
library(tidyverse)
library(magrittr)
library(ggplot2)
# library(patchwork)
library(sandwich)
library(lmtest)
library(car) #use vif function
library(cowplot)
# library(janitor)
# library(openxlsx)
library(dplyr)
library(knitr)
library(waffle)
library("PerformanceAnalytics")
library(ggrepel)
library(gridExtra)
```

```{r get robust ses }
rse <- function(model) { 
  sqrt(diag(vcovHC(model)))
  }
```
# Introduction

The year 2020 is known as the worst year in memorable history.  When the first wave of Covid-19 hit the U.S. in full force in March of 2020, the U.S. government did not have a plan on how to handle a pandemic.

State governors were left to fend largely for themselves with little Federal government guidance or relief.  They individually made decisions to provide protection and guidance to their constituents in order to keep them safe amidst the covid-19 pandemic whilst trying to keep businesses afloat and manage the economy to the best of their abilities.  Individual states have opened and closed businesses, required masks, and taken other measures with varying degrees of success.  Because of this, it’s difficult to ascertain what works, what doesn’t, and what the impact of those well intentioned measures are on covid-19 cases.  

It is critical that we reach a deeper understanding of these differences in order to respond with appropriate public policies. Our team will clean and analyse data to see what patterns we can find that can help inform U.S. state governors as they seek guidance on what policies are effective and to help them to make the best decisions possible for their constituents.  We recognize that the data will not be as perfect as we would like.  We plan to clean the data in order to enable a conformed dataset to ensure our research is performed with scientific rigor and integrity to the best of our ability. The plan is to take into account differences between states but also see what correlations we can find overall across the U.S by leveraging data across 4/12/2020 through 3/25/2021.

## Research Question
We want to understand if state level government interventions are correlated with Covid-19-deaths.  We defined government interventions as mask required in public, shelter in place, quarantine for travellers as it relates to covid-19 deaths.

**Our research question is: Is there an impact from government interventions on covid-19 death toll?**

A Structural Equation Model was created to understand the relationship between the Covid-19 death toll and other factors, including the mandates (Fig 1).

!["SEM"](SEM-F1.png)
_Fig 1: Structural Equation Model for Covid-19 deaths and government interventions._

After completing the SEM, we considered also two subquestions:

- Is the period of +/- fifteen days prior to and after a holiday increasing the Covid-19 deaths?

- Is the population density influencing Covid-19 deaths?


From all the US holidays, we focused this study on three of them: Mother's day, Election day and Thanksgiving. We selected Mother's day because it's an important US holiday that occurred early in the pandemic, we chose election day because we expected many people might ignore recommended mandates in order to vote in person which may have an impact in Covid-19 deaths, and we picked Thanksgiving because it's the most popular travel holiday in the US.

Mandates were not enforced in multiple states consistently during the holidays. 
We calculated the death toll during a holiday period by subtracting the death toll at the end and start dates. Then we evaluated the effect of the mandates. For each covariate, we aggregated the total days when the mandate was in effect.

For example, the case when the mandate is enforced from the holiday to the next three days was considered as a total of four days.

```{r holiday_diagram, echo=FALSE, warning=FALSE}

# mandate <- rep(c(0, 1), each = 10)
# holiday <- rep(c(0, 1), each = 5)

# both_cond<- c(`no mandate enforced`= 3, `holiday`=1, `mandate enforced+holiday`= 3)
# waffle(both_cond, rows = 1, size = 1, colors = c("#969696", "#1879bf", "#009bda"),
#        title = "Holiday period and mask enforcement")

```

# Model Building Process

## Data
In order to answer the research question, our team has gathered information from the following sources which are described below:

- The raw data was sourced from [COVID-19 Data Repository](https://github.com/CSSEGISandData/COVID-19/tree/master/csse_covid_19_data) by the Center for Systems Science and Engineering (CSSE) at Johns Hopkins University [1]. Data columns we are considering for our study:
```{r table_raw, echo=FALSE}
raw_info<- data.frame(
  spec = c("US State",
           "Date",
           "Covid-19 Cases",
           "Mask mandate enforced - start",
           "Mask mandate enforced - end",
           "Shelter in place - start",
           "Shelter in place - end",
           "Quarantine for travelers - start",
           "Quarantine for travelers - end",
           "Population",
           "Density",
           "Elected party"),
  description = c("US State name or district",
                  "Date in format MM/DD/YYYY", 
                  "Counts include confirmed and probable (where reported)",
                  "Date in format MM/DD/YYYY",
                  "Date in format MM/DD/YYYY",
                  "Date in format MM/DD/YYYY",
                  "Date in format MM/DD/YYYY",
                  "Date in format MM/DD/YYYY",
                  "Date in format MM/DD/YYYY",
                  "Population from 2018",
                  "Population per square mile",
                  "State results in 2020 presidential elections")
)

kable(raw_info, caption="Table 1. Filtered raw data from source")
```

- Holidays were taken from the python-holidays module.

- State results from presidential election were taken from [wikipedia](https://en.wikipedia.org/wiki/2020_United_States_presidential_election
).

## Data Loading 

We wrangled the data to achieve the following structure:

```{r table_processed, echo=FALSE}
raw_info2<- data.frame(
  spec = c("US State",
           "Covid-19 Cases",
           "Deaths",
           "Mask in public",
           "Shelter in place",
           "Quarantine for travellers",
           "Density",
           "Party"),
  description = c("US State name or district", 
                  "Case count for the state per 100k people",
                  "Death toll for the state per 100k people",
                  "Aggregated days when mask in public mandate was required (end date - start date)",
                  "Aggregated days when shelter in place was enforced (end date - start date)",
                  "Aggregated days when Quarantine for travellers was enforced (end date - start date)",
                  "Population per square mile",
                  "Democrat or Republican")
)

kable(raw_info2, caption="Table 2. Processed data from raw data")
```

## Data Wrangling

The raw data included a full year across US States. We sliced the data specifically specifically for the three aforementioned holidays. We considered population density as it relates the three holidays we chose to study.

```{r new_vars, echo=FALSE, warning=FALSE, message=FALSE}
covid_df <- readr::read_csv("../data/processed/covid_states_mask_v2.csv")

# Standardized cases considering population
covid_df$covid_cases_mil <- ((covid_df$total_covid_cases - covid_df$covid_total_on_4_12_2020)/covid_df$population_2018)*100000

# Standardized death toll considering population
covid_df$covid_deaths_mil <- (covid_df$total_covid_deaths/covid_df$population_2018)*100000 

covid_df <- covid_df %>% mutate_at(vars(covid_cases_mil, covid_deaths_mil), funs(round(., 0)))

# Create a column as category of strict enforcement and low enforcement of mask mandate.
# covid_df$mask_mandate_rigor <- ifelse(covid_df$sum_facemask_enforced >=200, "High rigor", "Low rigor")
# str(covid_df)

covid_df$party <- ifelse(covid_df$winning_part_2020_presidential_election == "Democrat", 0, 1)

covid_df$log_deaths_mil <- log(covid_df$covid_deaths_mil)

### Data frames based on specific dates

## Elections
election_df <- readr::read_csv("../data/processed/covid_states_mask_election_day_v3.csv")

# Standardized death toll considering population
election_df$covid_deaths_std <- round((election_df$total_covid_deaths/election_df$population_2018)*100000, 0)

# Transformed response variable
election_df$log_deaths_mil <- log(election_df$covid_deaths_std)

# Party
election_df$party <- ifelse(election_df$winning_part_2020_presidential_election == "Democrat", 0, 1)

## Mother's day
mothers_df <- readr::read_csv("../data/processed/covid_states_mask_mothers_day_v3.csv")

# Standardized death toll considering population
mothers_df$covid_deaths_std <- round((mothers_df$total_covid_deaths/mothers_df$population_2018)*100000, 0)

# Standardized cases considering population
mothers_df$covid_cases_mil <- ((mothers_df$total_covid_cases)/mothers_df$population_2018)*100000

# Transformed response variable
mothers_df$log_deaths_mil <- log(mothers_df$covid_deaths_std)

# Party
mothers_df$party <- ifelse(mothers_df$winning_part_2020_presidential_election == "Democrat", 0, 1)

## Thanksgiving
thanks_df <- readr::read_csv("../data/processed/covid_states_mask_thxgiving_day_v3.csv")

# Standardized death toll considering population
thanks_df$covid_deaths_std <- round((thanks_df$total_covid_deaths/thanks_df$population_2018)*100000, 0)

# Transformed response variable
thanks_df$log_deaths_mil <- log(thanks_df$covid_deaths_std)

# Party
thanks_df$party <- ifelse(thanks_df$winning_part_2020_presidential_election == "Democrat", 0, 1)

## Mix column at different times

df<- merge(mothers_df[,c("X1","province_state", "party", "winning_part_2020_presidential_election", 
                         "population_density_sqmiles", "population_2018" ,"covid_deaths_std","sum_facemask_enforced",
                         "sum_shelter_in_place", "sum_quarantine_travellers" )], 
           election_df[,c("province_state", "covid_deaths_std","sum_facemask_enforced","sum_shelter_in_place",
                                    "sum_quarantine_travellers")], by = "province_state") %>%
  merge(thanks_df[,c("province_state", "covid_deaths_std","sum_facemask_enforced","sum_shelter_in_place",
                                    "sum_quarantine_travellers")], by = "province_state")

new_names<- c("province_state",  "X1", "party", 
              "winning_part_2020_presidential_election", "population_density_sqmiles", "population_2018",
"covid_deaths_std.m", "sum_facemask_enforced.m", "sum_shelter_in_place.m", "sum_quarantine_travellers.m",             "covid_deaths_std.e", "sum_facemask_enforced.e", "sum_shelter_in_place.e", "sum_quarantine_travellers.e",             "covid_deaths_std.t", "sum_facemask_enforced.t", "sum_shelter_in_place.t", "sum_quarantine_travellers.t")   

df<- df %>% `colnames<-` (new_names)

df$density <- ifelse(df$population_density_sqmiles>200, "High", ifelse(df$population_density_sqmiles<100,"Low","Med"))
```

The population density might affect how fast the virus spreads. We divided the states in three groups: High, Med, Low. High density includes all the states with more than 200 people per square mile, then med density is the interval between a 100 and 199, and low density is any value less than 100. 

```{r}
# Density impact
gather(df, "covid_deaths_std.m","covid_deaths_std.e","covid_deaths_std.t", key="holiday", value="deaths") %>% 
  ggplot(aes(x=holiday, y=deaths, color=density)) +
  geom_boxplot()
```

_Figure 2. Death toll during Election day, Mother's day and Thanksgiving._

The plot above shows how in low density states, the spread during multiple holidays didn't change significantly. On the other hand, medium and high density populations seem to have a lot of variation during thanksgiving. Finally, we notice how high density populations are more susceptible to change during holidays. The two states with very high death toll during the Thanksgiving holiday are Texas and Indiana. These two are far away from the average value of approximately 35 amongst the three holidays.

The next plot shows the impact of interventions as they relate to the selected holidays. Red observations represent Republicans and blue represent Democrats. We noticed that the shelter in place mandate seem to be more effective for the holiday earlier in the year (Mother's day). It could be that in the holidays later in the year, the mandate was lifted due to Covid-19 fatigue.

```{r multiple-holiday scatter}

## Mothers day and interventions
a1<- ggplot(df, 
       aes(x=(sum_facemask_enforced.m), y= (covid_deaths_std.m)
           , color=winning_part_2020_presidential_election
           , size= population_density_sqmiles
           )) +
  geom_point() +
  # geom_text_repel(aes(label=province_state)) + 
  ggtitle("Public facemask") +
  xlab("") +
  ylab("Mother's day deaths") +
  theme(legend.position="none") 
# + labs(size="Density, in/sq.miles",
       # color="Party")

a2<- ggplot(df, 
       aes(x=(sum_shelter_in_place.m), y= (covid_deaths_std.m)
           , color=winning_part_2020_presidential_election
           , size= population_density_sqmiles
           )) +
  geom_point() +
  # geom_text_repel(aes(label=province_state)) + 
  ggtitle("Shelter in place") +
  xlab("") +
  ylab("") +
  theme(legend.position="none") 
# + labs(size="Density, in/sq.miles",
       # color="Party")

a3<- ggplot(df, 
       aes(x=(sum_quarantine_travellers.m), y= (covid_deaths_std.m)
           , color=winning_part_2020_presidential_election
           , size= population_density_sqmiles
           )) +
  geom_point() +
  # geom_text_repel(aes(label=province_state)) + 
  ggtitle("Quarantine for travelers") +
  xlab("") +
  ylab("") +
  theme(legend.position="none") 
# + labs(size="Density, in/sq.miles",
       # color="Party")

## Election days and interventions

b1<- ggplot(df, 
       aes(x=(sum_facemask_enforced.e), y= (covid_deaths_std.e)
           , color=winning_part_2020_presidential_election
           , size= population_density_sqmiles
           )) +
  geom_point() +
  # geom_text_repel(aes(label=province_state)) + 
  # ggtitle("Deaths and public facemask") +
  xlab("") +
  ylab("Elections Deaths") +
  theme(legend.position="none") 
# + labs(size="Density, in/sq.miles",
       # color="Party")

b2<- ggplot(df, 
       aes(x=(sum_shelter_in_place.e), y= (covid_deaths_std.e)
           , color=winning_part_2020_presidential_election
           , size= population_density_sqmiles
           )) +
  geom_point() +
  # geom_text_repel(aes(label=province_state)) + 
  # ggtitle("Deaths and public facemask") +
  xlab("") +
  ylab("") +
  theme(legend.position="none") 
# + labs(size="Density, in/sq.miles",
       # color="Party")

b3<- ggplot(df, 
       aes(x=(sum_quarantine_travellers.e), y= (covid_deaths_std.e)
           , color=winning_part_2020_presidential_election
           , size= population_density_sqmiles
           )) +
  geom_point() +
  # geom_text_repel(aes(label=province_state)) + 
  # ggtitle("Deaths and public facemask") +
  xlab("") +
  ylab("") +
  theme(legend.position="none") 
# + labs(size="Density, in/sq.miles",
       # color="Party")

## Thanksgiving deaths and inverventions

c1<- ggplot(df, 
       aes(x=(sum_facemask_enforced.t), y= (covid_deaths_std.t)
           , color=winning_part_2020_presidential_election
           , size= population_density_sqmiles
           )) +
  geom_point() +
  # geom_text_repel(aes(label=province_state)) + 
  # ggtitle("Deaths and public facemask") +
  xlab("") +
  ylab("Thanksgiving deaths") +
  theme(legend.position="none") 
# + labs(size="Density, in/sq.miles",
       # color="Party")

c2<- ggplot(df, 
       aes(x=(sum_shelter_in_place.t), y= (covid_deaths_std.t)
           , color=winning_part_2020_presidential_election
           , size= population_density_sqmiles
           )) +
  geom_point() +
  # geom_text_repel(aes(label=province_state)) + 
  # ggtitle("Deaths and public facemask") +
  xlab("days") +
  ylab("") +
  theme(legend.position="none") 
# + labs(size="Density, in/sq.miles",
       # color="Party")

c3<- ggplot(df, 
       aes(x=(sum_quarantine_travellers.t), y= (covid_deaths_std.t)
           , color=winning_part_2020_presidential_election
           , size= population_density_sqmiles
           )) +
  geom_point() +
  # geom_text_repel(aes(label=province_state)) + 
  # ggtitle("Deaths and public facemask") +
  xlab("") +
  ylab("") +
  theme(legend.position="none") 
# + labs(size="Density, in/sq.miles",
       # color="Party")

grid.arrange(a1, a2, a3,
             b1, b2, b3,
             c1, c2, c3,
             nrow = 3,
             ncol = 3)
```

_Figure 3. Death toll during multiple holidays and relationship to Public face mask, shelter in place, and quarantine for travelers mandates._

We focused on a specific holiday, such as mother's day. The reason for focusing on this particular period of time is because we can see how multiple states were implementing interventions during the 30 days (holiday +/- 15 days). As we can see in the other holidays, the interventions become more binary (zero or the max value), sometimes with very few observations in each of them. 

For example, the shelter in place with only two states (California and New Mexico) with the mandate effective. We don't believe that would be a representative option to measure the impact of that intervention. This study will cover only the Mother's day period. California is a state with the highest population. New Mexico is the poorest state in the USA and with less hospitals and beds for Covid-19 patients [9].

```{r high-med-density}
# high_d<- df %>% select(c("province_state",  "X1", "party", 
#               "winning_part_2020_presidential_election", "population_density_sqmiles", "population_2018",
# "covid_deaths_std.m", "sum_facemask_enforced.m", "sum_shelter_in_place.m", "sum_quarantine_travellers.m","density")) %>% 
#   dplyr::filter(density == "High")
# 
# med_d<- df %>% select(c("province_state",  "X1", "party", 
#               "winning_part_2020_presidential_election", "population_density_sqmiles", "population_2018",
# "covid_deaths_std.m", "sum_facemask_enforced.m", "sum_shelter_in_place.m", "sum_quarantine_travellers.m","density")) %>% 
#   dplyr::filter(density == "Med") 

```

## Study Design

We want to measure the impact of government interventions in the Covid-19 death toll during the Mother's day period. Each observation will be recorded at a state level. The model will be created by 51 observations, each of them composed of the following features:

```{r processed_data, echo=FALSE}
raw_info3<- data.frame(
  code = c("D",
           "M",
           "S",
           "Q",
           "P"),
  description = c("Death toll per 100k people",
                  "Aggregated days when mask in public required",
                  "Aggregated days when shelter in place was enforced",
                  "Aggregated days when Quarantine for travelers was enforced",
                  "Elected party affiliation"),
  domain = c("0 - 61", 
             "0 - 30",
             "0 - 30",
             "0 - 30",
             "Democrat (0) or Republican (1)")
)

kable(raw_info3, caption="Table 2. Processed data from Mother's day")
```

## Model goals

Three models seek to explain the impact of government interventions considering the specifications stated in the SEM in Figure 1, which showed the theoretical relationships between the increase or decrease of Covid-19 deaths and multiple factors. The heatmap below shows similar patterns by Covid-19 deaths and cases. We've chose deaths as our response variable because we believe there's a smaller variation embedded in how the deaths were recorded compared to Covid-19 cases across all the USA.

It must be flagged here that Oregon changed the way they reported the total cases of confirmed cases and switched from number of tests to number of persons tested. There is a lot of variation from state to state that is linked to different approaches when measuring total cases. For this reason, we decided to use the variable of death toll instead of confirmed cases.

```{r plot_usa, echo=FALSE, warning=FALSE, message=FALSE, fig.height=5, fig.width=3}
 a.par <- par(mfrow=c(1, 3))
p <- plot_usmap(data = mothers_df, values = "covid_deaths_std", regions = "states", color="red", labels=T) +
   labs(title = "U.S. States",
        subtitle = "COVID-19 Deaths by State.") +
 scale_fill_continuous(low = "white", high = "red", name = "COVID-19 Deaths", label = scales::comma) +
   theme(panel.background=element_blank(), legend.position = "right")
 
# Set label font size
p$layers[[2]]$aes_params$size <- 2
print(p)
c<- plot_usmap(data = mothers_df, values = "covid_cases_mil", regions = "states", color="blue", labels=T, label_color="black") +
   labs(title = "U.S. States",
        subtitle = "COVID-19 Cases by State.") +
 scale_fill_continuous(low = "white", high = "blue", name = "COVID-19 Cases", label = scales::comma) +
   theme(panel.background=element_blank(), legend.position = "right")
c$layers[[2]]$aes_params$size <- 2
print(c)
# m<- plot_usmap(data = covid_df, values = "sum_facemask_citation_fine", regions = "states", color="green", labels=T) +
#    labs(title = "U.S. States",
# subtitle = "Facemask Enforced by State.") +
#  scale_fill_continuous(low = "white", high = "green", name = "Facemask enforced", label = scales::comma) +
#    theme(panel.background=element_blank(), legend.position = "right")
# m$layers[[2]]$aes_params$size <- 2
# print(m)
```

_Figure 4. (Left) Death toll by state. (Right) Covid-19 cases by state._

### Model 1: Limited model

The mask mandate has been subject to controversy since the pandemic started, having multiple countries and the WHO providing multiple standards on face mask use in community settings [2]. We believe that there is a negative correlation between Covid-19 deaths and the total days the mask in public mandate was required.

$$y = D = \beta_0 + \beta_1M$$

### Model 2: Extended model

The extended model includes the rest of the government interventions which are shelter in place and quarantine for travelers. We believe that during the holiday season, the mobility was increased in all the states. Is not always the case that the interventions coincided with the holidays. If our original intuition about mask mandate has a large effect, we expect to see that in the holidays when people had a higher interaction and consequentially, the Covid-19 deaths would be reduced if more interventions were in place. In all of the variables proposed in the extended model we expect a negative correlation to the response variable.

$$y = D = \beta_0 +\beta_1M +\beta_2S +\beta_3Q$$

### Model 3: Full model 

The full model will take into account the political party the state voted during 2020 elections. We chose this variable because democratic states supported the introduction of government interventions in a larger degree compared to republican states:

$$y = D = \beta_0 +\beta_1M +\beta_2S +\beta_3Q + + \beta_4P$$

## Statistical Methods

### EDA

Before running the proposed models, we looked the correlation matrix of the variables of interest.

```{r cor_chart, echo=FALSE}
# democrats <- covid_df %>% 
#   filter(winning_part_2020_presidential_election == "Democrat")
# 
# chart.Correlation(democrats[,c("covid_deaths_mil", "sum_facemask_enforced", "sum_shelter_in_place", "sum_quarantine_travellers", "sum_holiday_face_mask_citation_fine")], histogram=TRUE, pch=19) +

# # All data
# chart.Correlation(covid_df[,c("covid_deaths_mil", 
#                   "sum_facemask_enforced", 
#                   "sum_shelter_in_place", 
#                   "sum_quarantine_travellers", 
#                   "sum_holiday_face_mask_citation_fine")],
#       # histogram=TRUE,
#       # diagonal = "hist",
#       # pch=19,
#       labels = c("deaths",
#                   "mask in public",
#                   "shelter in place",
#                   "quarantine for travelers", 
#                   "enforced mask & holiday")
#       # lower= c("cor","none")
#       )

# Elections

# chart.Correlation(high_d[,c("covid_deaths_std.m", 
#                   "sum_facemask_enforced.m", 
#                   "sum_shelter_in_place.m", 
#                   "sum_quarantine_travellers.m", 
#                   "population_density_sqmiles"
#                   )],
#       # histogram=TRUE,
#       # diagonal = "hist",
#       # pch=19,
#       labels = c("deaths",
#                   "mask in public",
#                   "shelter in place",
#                   "quarantine for travelers", 
#                   "pop density")
#       # lower= c("cor","none")
#       )
```

The correlation matrix (Figure 5) provides the big picture of the relationships between all the variables of interest.
It seems that Covid-19 deaths is not normally distributed, showing a skew to the left. Days of shelter in place has a large skew to the left.
The remaining variables, days of face mask enforced, days of quarantine for travelers, and days of mask enforced during holiday seemed to be part of two populations.

```{r echo=FALSE}
# republicans <- covid_df %>% 
#   filter(winning_part_2020_presidential_election == "Republican")
# 
# chart.Correlation(republicans[,c("covid_deaths_mil", "sum_facemask_enforced", "sum_shelter_in_place", "sum_quarantine_travellers", "sum_holiday_face_mask_citation_fine")], histogram=TRUE, pch=19)

# Mother's day
chart.Correlation(mothers_df[,c("covid_deaths_std", 
                  "sum_facemask_enforced", 
                  "sum_shelter_in_place", 
                  "sum_quarantine_travellers" 
                  # "sum_facemask_citation_fine"
                  )],
      # histogram=TRUE,
      # diagonal = "hist",
      # pch=19,
      labels = c("deaths",
                  "mask in public",
                  "shelter in place",
                  "quarantine for travelers" 
                  # "enforced mask & holiday"
                 )
      # lower= c("cor","none")
    )
```

_Figure 5. Correlation matrix for death toll, public face mask, shelter in place, and quarantine for travelers during Mother's day._

```{r}
# chart.Correlation(covid_df[,c("covid_deaths_mil", "sum_facemask_enforced", "sum_shelter_in_place", "sum_quarantine_travellers", "sum_holiday_face_mask_citation_fine")], histogram=TRUE, pch=19)

# # Thankgiving's day
# chart.Correlation(thanks_df[,c("covid_deaths_std", 
#                   "sum_facemask_enforced", 
#                   "sum_shelter_in_place", 
#                   "sum_quarantine_travellers", 
#                   "sum_facemask_citation_fine"
#                   )],
#       # histogram=TRUE,
#       # diagonal = "hist",
#       # pch=19,
#       labels = c("deaths",
#                   "mask in public",
#                   "shelter in place",
#                   "quarantine for travelers", 
#                   "enforced mask & holiday")
#       # lower= c("cor","none")
#       )
```

<!-- #### Covid-19 deaths -->

<!-- Now let's look specifically the Covid-19 deaths per 100k inhabitants during Mother's day. -->

```{r y_var_hist}

par(mfrow=c(2,2))

# histogram of deaths all time
# hist(covid_df$covid_deaths_mil, breaks=20,
#      main = "Covid-19 deaths per 100k",
#      xlab = "Deaths")
# hist(log(covid_df$covid_deaths_mil), breaks=20,
#      main = NULL,
#      xlab = "log(deaths)")
# hist(sqrt(covid_df$covid_deaths_mil), breaks=20,
#      main = NULL,
#      xlab = "sqrt(deaths)")
# hist(1/(covid_df$covid_deaths_mil), breaks=20,
#      main = NULL,
#      xlab = "1/(deaths)")

# # histogram elections - Deaths
# hist(election_df$covid_deaths_std, breaks=20,
#      main = "Covid-19 deaths per 100k",
#      xlab = "Deaths")
# hist(log(election_df$covid_deaths_std), breaks=20,
#      main = NULL,
#      xlab = "log(deaths)")
# hist(sqrt(election_df$covid_deaths_std), breaks=20,
#      main = NULL,
#      xlab = "sqrt(deaths)")
# hist(1/(election_df$covid_deaths_std), breaks=20,
#      main = NULL,
#      xlab = "1/(deaths)")
```

```{r histogram-transf D mothers}
# par(mfrow=c(2,2))
# 
# # histogram mothers - Deaths
# hist(mothers_df$covid_deaths_std, breaks=20,
#      main = "Covid-19 deaths per 100k",
#      xlab = "Deaths")
# hist(log(mothers_df$covid_deaths_std), breaks=20,
#      main = NULL,
#      xlab = "log(deaths)")
# hist(sqrt(mothers_df$covid_deaths_std), breaks=20,
#      main = NULL,
#      xlab = "sqrt(deaths)")
# hist(1/(mothers_df$covid_deaths_std), breaks=20,
#      main = NULL,
#      xlab = "1/(deaths)")
```


#### Facemask required in public spaces

```{r pub_mask}

# histogram of facemask enforced
# p1<- ggplot(covid_df, aes(sum_facemask_enforced)) +
#      geom_histogram() +
#      geom_vline(aes(xintercept=mean(sum_facemask_enforced)),
#             color="blue", linetype="dashed", size=1) +
#      ggtitle("Facemask in public") +
#      xlab("days") 
# 
# # library(gridExtra)
# p2<- ggplot(covid_df, 
#        aes(x=(sum_facemask_enforced), y= log(covid_deaths_mil)
#            , color=winning_part_2020_presidential_election
#            # , size=population_density_sqmiles
#            , size= population_density_sqmiles
#            )) +
#   geom_point() +
#   # geom_text_repel(aes(label=province_state)) + 
#   ggtitle("Deaths and public facemask") +
#   xlab("days") +
#   ylab("log Covid-19 deaths per 100k") +
#   theme(legend.position="right") +
#   labs(size="Density, in/sq.miles",
#        color="Party")


# ## histogram facemask - Elections
# p1<- ggplot(election_df, aes(sum_facemask_enforced)) +
#      geom_histogram() +
#      geom_vline(aes(xintercept=mean(sum_facemask_enforced)),
#             color="blue", linetype="dashed", size=1) +
#      ggtitle("Facemask in public - Election") +
#      xlab("days") 
# 
# # library(gridExtra)
# p2<- ggplot(election_df, 
#        aes(x=(sum_facemask_enforced), y= log(covid_deaths_std)
#            , color=winning_part_2020_presidential_election
#            # , size=population_density_sqmiles
#            , size= population_density_sqmiles
#            )) +
#   geom_point() +
#   # geom_text_repel(aes(label=province_state)) + 
#   ggtitle("Deaths and public facemask") +
#   xlab("days") +
#   ylab("log Covid-19 deaths per 100k") +
#   theme(legend.position="right") +
#   labs(size="Density, in/sq.miles",
#        color="Party")
# 
# grid.arrange(p1, p2, nrow = 2)

```

```{r}
# ## histogram facemask - Mother's day
# p1<- ggplot(df, aes(sum_facemask_enforced.m)) +
#      geom_histogram() +
#      geom_vline(aes(xintercept=mean(sum_facemask_enforced.m)),
#             color="blue", linetype="dashed", size=1) +
#      ggtitle("Face mask in public - Mother's day") +
#      xlab("days")


p2<- ggplot(df,
       aes(x=(sum_facemask_enforced.m), y= (covid_deaths_std.m)
           , color=winning_part_2020_presidential_election
           # , size=population_density_sqmiles
           , size= population_density_sqmiles
           )) +
  geom_point() +
  geom_text_repel(aes(label=province_state)) +
  ggtitle("Deaths and public facemask - Mother's day") +
  xlab("days") +
  ylab("Covid-19 deaths per 100k") +
  theme(legend.position="right") +
  labs(size="Density, in/sq.miles",
       color="Party")

grid.arrange(p2, 
             # p2, 
             nrow = 1)
```

_Figure 6. Relationship between death's and effective days of public face masks._

```{r hist scat facemask thnx}
# ## histogram facemask - Thanksgiving
# p1<- ggplot(thanks_df, aes(sum_facemask_enforced)) +
#      geom_histogram() +
#      geom_vline(aes(xintercept=mean(sum_facemask_enforced)),
#             color="blue", linetype="dashed", size=1) +
#      ggtitle("Facemask in public - Thanksgiving") +
#      xlab("days") 
# 
# # library(gridExtra)
# p2<- ggplot(thanks_df, 
#        aes(x=(sum_facemask_enforced), y= log(covid_deaths_std)
#            , color=winning_part_2020_presidential_election
#            , size= population_density_sqmiles
#            )) +
#   geom_point() +
#   # geom_text_repel(aes(label=province_state)) + 
#   ggtitle("Deaths and public facemask") +
#   xlab("days") +
#   ylab("sqrt Covid-19 deaths per 100k") +
#   theme(legend.position="right") +
#   labs(size="Density, in/sq.miles",
#        color="Party")
# 
# grid.arrange(p1, p2, nrow = 2)
```

The states with lowest Covid-19 deaths are Hawaii, Alaska, Maine, Vermont and Oregon. They all seem to have a similar population density except for Alaska. Hawaii is naturally isolated to the rest of the US States. It might even be considered an outlier in terms of connectivity with the rest of the states [3]. 

It is evident that states with the highest density seem to land  towards the top right of the plot (Figure 6). We can also notice that most of the democratic states had a longer public face mask mandate requirement period while the majority of republican states didn't required it. 

The second state with lowest deaths is Vermont, which has been set as an example to the US, following a strict interventions from the beginning of the pandemic [4]. Oregon seems to have follow a strict path similar to Vermont, in both states, there has been 'relatively good adherence with guidelines' [5]. 

```{r pub_mask_party}

# p1 <- covid_df %>%
#   select(province_state,
#          sum_facemask_enforced,
#          covid_deaths_mil, 
#          winning_part_2020_presidential_election,
#          population_density_sqmiles) %>% 
#   filter(winning_part_2020_presidential_election == "Democrat") %>%
#   ggplot(aes(x=(sum_facemask_enforced), y= log(covid_deaths_mil),
#            # color=winning_part_2020_presidential_election,
#            # size=population_density_sqmiles)
#           )
#          ) +
#   geom_point() +
#   # geom_text_repel(aes(label=province_state)) + 
#   ggtitle("Deaths and public facemask") +
#   xlab(NULL) +
#   ylab("log Covid-19 deaths per 100k")
# 
# p2 <- covid_df %>%
#   select(province_state,
#          sum_facemask_enforced,
#          covid_deaths_mil, 
#          winning_part_2020_presidential_election,
#          population_density_sqmiles) %>% 
#   filter(winning_part_2020_presidential_election == "Republican") %>%
#   ggplot(aes(x=(sum_facemask_enforced), y= log(covid_deaths_mil),
#            # color=winning_part_2020_presidential_election,
#            # size=population_density_sqmiles)
#           )
#          )+
#   geom_point() +
#   # geom_text_repel(aes(label=province_state)) + 
#   ggtitle("Above: Democrat states - Below: Republican states") +
#   xlab("days") +
#   ylab("log Covid-19 deaths per 100k")

# ## Deaths and facemask by party - Election
# 
# p1 <- election_df %>%
#   select(province_state,
#          sum_facemask_enforced,
#          covid_deaths_std, 
#          winning_part_2020_presidential_election,
#          population_density_sqmiles) %>% 
#   filter(winning_part_2020_presidential_election == "Democrat") %>%
#   ggplot(aes(x=(sum_facemask_enforced), y= log(covid_deaths_std),
#            # color=winning_part_2020_presidential_election,
#            # size=population_density_sqmiles)
#           )
#          ) +
#   geom_point() +
#   # geom_text_repel(aes(label=province_state)) + 
#   ggtitle("Deaths and public facemask") +
#   xlab(NULL) +
#   ylab("log Covid-19 deaths per 100k")
# 
# p2 <- election_df %>%
#   select(province_state,
#          sum_facemask_enforced,
#          covid_deaths_std, 
#          winning_part_2020_presidential_election,
#          population_density_sqmiles) %>% 
#   filter(winning_part_2020_presidential_election == "Republican") %>%
#   ggplot(aes(x=(sum_facemask_enforced), y= log(covid_deaths_std),
#            # color=winning_part_2020_presidential_election,
#            # size=population_density_sqmiles)
#           )
#          )+
#   geom_point() +
#   # geom_text_repel(aes(label=province_state)) + 
#   ggtitle("Above: Democrat states - Below: Republican states") +
#   xlab("days") +
#   ylab("log Covid-19 deaths per 100k")
# 
# grid.arrange(p1, p2, nrow = 2)
```


```{r pub_mask_party_mothers}
# ## Deaths and facemask by party - Mother's
# 
# p1 <- thanks_df %>%
#   select(province_state,
#          sum_facemask_enforced,
#          covid_deaths_std, 
#          winning_part_2020_presidential_election,
#          population_density_sqmiles) %>% 
#   filter(winning_part_2020_presidential_election == "Democrat") %>%
#   ggplot(aes(x=(sum_facemask_enforced), y= log(covid_deaths_std),
#            # color=winning_part_2020_presidential_election,
#            # size=population_density_sqmiles)
#           )
#          ) +
#   geom_point() +
#   # geom_text_repel(aes(label=province_state)) + 
#   ggtitle("Deaths and public facemask") +
#   xlab(NULL) +
#   ylab("log Covid-19 deaths per 100k")
# 
# p2 <- thanks_df %>%
#   select(province_state,
#          sum_facemask_enforced,
#          covid_deaths_std, 
#          winning_part_2020_presidential_election,
#          population_density_sqmiles) %>% 
#   filter(winning_part_2020_presidential_election == "Republican") %>%
#   ggplot(aes(x=(sum_facemask_enforced), y= log(covid_deaths_std),
#            # color=winning_part_2020_presidential_election,
#            # size=population_density_sqmiles)
#           )
#          )+
#   geom_point() +
#   # geom_text_repel(aes(label=province_state)) + 
#   ggtitle("Above: Democrat states - Below: Republican states") +
#   xlab("days") +
#   ylab("log Covid-19 deaths per 100k")
# 
# boxplot(log(covid_deaths_std)~sum_facemask_enforced, data=thanks_df, 
#         xlab="Dem:0, Rep:1",
#         ylab="log Deaths per 100k",
#         main= "Thanksgiving")
# 
# grid.arrange(p1, p2, nrow = 2)
```

#### Shelter in place

```{r shelter}

# Add only labels for outliers
# shelter <- subset(covid_df, province_state == "California"  | province_state == "New Mexico")
# shelter2 <- covid_df
# covid_df$sh_label <- ""
# 
# sh_ix <- c(5,32)
# 
# covid_df$sh_label[sh_ix] <- shelter2$province_state[sh_ix] 
# 
# # histogram of shelter in place
# p1<- ggplot(covid_df, aes(sum_shelter_in_place)) +
#      geom_histogram() +
#      geom_vline(aes(xintercept=mean(sum_shelter_in_place)),
#             color="blue", linetype="dashed", size=1) +
#      ggtitle("Shelter in place") +
#      xlab("days") 
# 
# # Scatterplot
# p2<- ggplot(covid_df, 
#        aes(x=(sum_shelter_in_place), y= log(covid_deaths_mil)
#            , color=winning_part_2020_presidential_election
#            # , size=population_density_sqmiles
#            , size= population_density_sqmiles
#            )) +
#   geom_point() +
#   geom_text_repel(aes(label= sh_label)) + 
#   ggtitle("Deaths and Shelter in place") +
#   xlab("days") +
#   ylab("log Covid-19 deaths per 100k") +
#   theme(legend.position="right") +
#   labs(size="Density, in/sq.miles",
#        color="Party")

# ## Shelter in place - Elections
# # histogram of shelter in place
# p1<- ggplot(election_df, aes(sum_shelter_in_place)) +
#      geom_histogram() +
#      geom_vline(aes(xintercept=mean(sum_shelter_in_place)),
#             color="blue", linetype="dashed", size=1) +
#      ggtitle("Shelter in place") +
#      xlab("days") 
# 
# # Scatterplot
# p2<- ggplot(election_df, 
#        aes(x=(sum_shelter_in_place), y= log(covid_deaths_std)
#            , color=winning_part_2020_presidential_election
#            # , size=population_density_sqmiles
#            , size= population_density_sqmiles
#            )) +
#   geom_point() +
#   geom_text_repel(aes(label= province_state)) + 
#   ggtitle("Deaths and Shelter in place") +
#   xlab("days") +
#   ylab("log Covid-19 deaths per 100k") +
#   theme(legend.position="right") +
#   labs(size="Density, in/sq.miles",
#        color="Party")
# 
# grid.arrange(p1, p2, nrow = 2)

```

```{r}
## Shelter in place - Mother's day
# # histogram of shelter in place
# p1<- ggplot(mothers_df, aes(sum_shelter_in_place)) +
#      geom_histogram() +
#      geom_vline(aes(xintercept=mean(sum_shelter_in_place)),
#             color="blue", linetype="dashed", size=1) +
#      ggtitle("Shelter in place - Mother's day") +
#      xlab("days") 

# Scatterplot
p2<- ggplot(mothers_df, 
       aes(x=(sum_shelter_in_place), y= (covid_deaths_std)
           , color=winning_part_2020_presidential_election
           # , size=population_density_sqmiles
           , size= population_density_sqmiles
           )) +
  geom_point() +
  geom_text_repel(aes(label= province_state)) + 
  ggtitle("Deaths and Shelter in place - Mother's day") +
  xlab("days") +
  ylab("Covid-19 deaths per 100k") +
  theme(legend.position="right") +
  labs(size="Density, in/sq.miles",
       color="Party")

grid.arrange(p2, 
             # p2, 
             nrow = 1)
```

_Figure 7. Relationship between death's and effective days of shelter in place._

```{r}
# ## Shelter in place - Thanksgiving
# # histogram of shelter in place
# p1<- ggplot(thanks_df, aes(sum_shelter_in_place)) +
#      geom_histogram() +
#      geom_vline(aes(xintercept=mean(sum_shelter_in_place)),
#             color="blue", linetype="dashed", size=1) +
#      ggtitle("Shelter in place - Thanksgiving") +
#      xlab("days") 
# 
# # Scatterplot
# p2<- ggplot(thanks_df, 
#        aes(x=(sum_shelter_in_place), y= (covid_deaths_std)
#            , color=winning_part_2020_presidential_election
#            # , size=population_density_sqmiles
#            , size= population_2018/1000000
#            )) +
#   geom_point() +
#   geom_text_repel(aes(label= province_state)) + 
#   ggtitle("Deaths and Shelter in place") +
#   xlab("days") +
#   ylab("Covid-19 deaths per 100k") +
#   theme(legend.position="right") +
#   labs(size="Population, millions",
#        color="Party")
# 
# grid.arrange(p1, p2, nrow = 2)
```

In this plot we see only two points with a longer shelter in place mandate compared to the rest of the states.  In general, days of shelter in place doesn't seem to have an influence on our response variable. We do see that most Democrat states seem to had the mandate for longer compared to Republican states.


#### Quarantine for travellers

```{r quarantine_hist}
# # histogram of Quarantine for travelers
# p1<- ggplot(covid_df, aes(sum_quarantine_travellers)) +
#      geom_histogram() +
#      geom_vline(aes(xintercept=mean(sum_quarantine_travellers)),
#             color="blue", linetype="dashed", size=1) +
#      ggtitle("Quarantine for travelers") +
#      xlab("days") 
# 
# # Scatterplot
# p2<- ggplot(covid_df, 
#        aes(x=(sum_quarantine_travellers), y= log(covid_deaths_mil)
#            , color=winning_part_2020_presidential_election
#            # , size=population_density_sqmiles
#            , size= population_density_sqmiles
#            )) +
#   geom_point() +
#   geom_text_repel(aes(label= sh_label)) + 
#   ggtitle("Deaths and Quarantine for travelers") +
#   xlab("days") +
#   ylab("log Covid-19 deaths per 100k") +
#   theme(legend.position="right") +
#   labs(size="Density, in/sq.miles",
#        color="Party")

# # histogram of Quarantine for travelers - Election
# p1<- ggplot(election_df, aes(sum_quarantine_travellers)) +
#      geom_histogram() +
#      geom_vline(aes(xintercept=mean(sum_quarantine_travellers)),
#             color="blue", linetype="dashed", size=1) +
#      ggtitle("Quarantine for travelers - Election") +
#      xlab("days") 
# 
# # Scatterplot
# p2<- ggplot(election_df, 
#        aes(x=(sum_quarantine_travellers), y= log(covid_deaths_std)
#            , color=winning_part_2020_presidential_election
#            # , size=population_density_sqmiles
#            , size= population_density_sqmiles
#            )) +
#   geom_point() +
#   geom_text_repel(aes(label= province_state)) + 
#   ggtitle("Deaths and Quarantine for travelers") +
#   xlab("days") +
#   ylab("log Covid-19 deaths per 100k") +
#   theme(legend.position="right") +
#   labs(size="Density, in/sq.miles",
#        color="Party")
# 
# grid.arrange(p1, p2, nrow = 2)

```


```{r}

# # histogram of Quarantine for travelers - Mother's
# p1<- ggplot(df, aes(sum_quarantine_travellers.m)) +
#      geom_histogram() +
#      geom_vline(aes(xintercept=mean(sum_quarantine_travellers.m)),
#             color="blue", linetype="dashed", size=1) +
#      ggtitle("Quarantine for travelers - Mother's") +
#      xlab("days") 

# Scatterplot
p2<- ggplot(df, 
       aes(x=(sum_quarantine_travellers.m), y= (covid_deaths_std.m)
           , color=winning_part_2020_presidential_election
           # , size=population_density_sqmiles
           , size= population_density_sqmiles
           )) +
  geom_point() +
  geom_text_repel(aes(label= province_state)) + 
  ggtitle("Deaths and Quarantine for travelers - Mother's day") +
  xlab("days") +
  ylab("Covid-19 deaths per 100k") +
  theme(legend.position="right") +
  labs(size="Density, in/sq.miles",
       color="Party")

grid.arrange(p2, 
             # p2, 
             nrow = 1)
```

_Figure 8. Relationship between death's and effective days of quarantine for travelers._

```{r}
# # histogram of Quarantine for travelers - Thanksgiving
# p1<- ggplot(thanks_df, aes(sum_quarantine_travellers)) +
#      geom_histogram() +
#      geom_vline(aes(xintercept=mean(sum_quarantine_travellers)),
#             color="blue", linetype="dashed", size=1) +
#      ggtitle("Quarantine for travelers - Thanksgiving") +
#      xlab("days") 
# 
# # Scatterplot
# p2<- ggplot(thanks_df, 
#        aes(x=(sum_quarantine_travellers), y= (covid_deaths_std)
#            , color=winning_part_2020_presidential_election
#            # , size=population_density_sqmiles
#            , size= population_density_sqmiles
#            )) +
#   geom_point() +
#   geom_text_repel(aes(label= province_state)) + 
#   ggtitle("Deaths and Quarantine for travelers") +
#   xlab("days") +
#   ylab("log Covid-19 deaths per 100k") +
#   theme(legend.position="right") +
#   labs(size="Density, in/sq.miles",
#        color="Party")
# 
# grid.arrange(p1, p2, nrow = 2)
```

The histogram of quarantine for travelers (Figure 6) shows the distribution of quarantine for travelers with a large skew to the left.
It implies that most of the states didn't have the mandate for a long time. Possibly a transformation of the variable quarantine for travelers might be used. We will evaluate the necessity in the following scatter plot.

<!-- #### Enforced mask by citation/fine during holidays -->

```{r enforcemask_holiday_hist}
# # histogram of facemask enforced
# p1<- ggplot(covid_df, aes(sum_holiday_face_mask_citation_fine)) +
#      geom_histogram() +
#      geom_vline(aes(xintercept=mean(sum_holiday_face_mask_citation_fine)),
#             color="blue", linetype="dashed", size=1) +
#      ggtitle("Enforced mask & holidays") +
#      xlab("days") 
# 
# # library(gridExtra)
# p2<- ggplot(covid_df, 
#        aes(x=(sum_holiday_face_mask_citation_fine), y= log(covid_deaths_mil)
#            , color=winning_part_2020_presidential_election
#            # , size=population_density_sqmiles
#            , size= population_density_sqmiles
#            )) +
#   geom_point() +
#   # geom_text_repel(aes(label=province_state)) + 
#   ggtitle("Deaths and Enforced mask + holidays") +
#   xlab("days") +
#   ylab("log Covid-19 deaths per 100k") +
#   theme(legend.position="right") +
#   labs(size="Density, in/sq.miles",
#        color="Party")

# # histogram of facemask enforced - Elections
# p1<- ggplot(election_df, aes(sum_facemask_citation_fine)) +
#      geom_histogram() +
#      geom_vline(aes(xintercept=mean(sum_facemask_citation_fine)),
#             color="blue", linetype="dashed", size=1) +
#      ggtitle("Enforced mask & holidays - Elections") +
#      xlab("days") 
# 
# # library(gridExtra)
# p2<- ggplot(election_df, 
#        aes(x=(sum_facemask_citation_fine), y= log(covid_deaths_std)
#            , color=winning_part_2020_presidential_election
#            # , size=population_density_sqmiles
#            , size= population_density_sqmiles
#            )) +
#   geom_point() +
#   # geom_text_repel(aes(label=province_state)) + 
#   ggtitle("Deaths and Enforced mask + holidays") +
#   xlab("days") +
#   ylab("log Covid-19 deaths per 100k") +
#   theme(legend.position="right") +
#   labs(size="Density, in/sq.miles",
#        color="Party")
# 
# grid.arrange(p1, p2, nrow = 2)
```

```{r}
# # histogram of facemask enforced - Mother's day
# p1<- ggplot(mothers_df, aes(sum_facemask_citation_fine)) +
#      geom_histogram() +
#      geom_vline(aes(xintercept=mean(sum_facemask_citation_fine)),
#             color="blue", linetype="dashed", size=1) +
#      ggtitle("Enforced mask & holidays - Mother's day") +
#      xlab("days") 
# 
# # library(gridExtra)
# p2<- ggplot(mothers_df, 
#        aes(x=(sum_facemask_citation_fine), y= log(covid_deaths_std)
#            , color=winning_part_2020_presidential_election
#            # , size=population_density_sqmiles
#            , size= population_density_sqmiles
#            )) +
#   geom_point() +
#   # geom_text_repel(aes(label=province_state)) + 
#   ggtitle("Deaths and Enforced mask + holidays") +
#   xlab("days") +
#   ylab("log Covid-19 deaths per 100k") +
#   theme(legend.position="right") +
#   labs(size="Density, in/sq.miles",
#        color="Party")
# 
# grid.arrange(p1, p2, nrow = 2)
```

```{r}
# # histogram of facemask enforced - thanksgiving
# p1<- ggplot(thanks_df, aes(sum_facemask_citation_fine)) +
#      geom_histogram() +
#      geom_vline(aes(xintercept=mean(sum_facemask_citation_fine)),
#             color="blue", linetype="dashed", size=1) +
#      ggtitle("Enforced mask & holidays - Thanksgiving") +
#      xlab("days") 
# 
# # library(gridExtra)
# p2<- ggplot(thanks_df, 
#        aes(x=(sum_facemask_citation_fine), y= (covid_deaths_std)
#            , color=winning_part_2020_presidential_election
#            # , size=population_density_sqmiles
#            , size= population_density_sqmiles
#            )) +
#   geom_point() +
#   # geom_text_repel(aes(label=province_state)) + 
#   ggtitle("Deaths and Enforced mask + holidays") +
#   xlab("days") +
#   ylab("log Covid-19 deaths per 100k") +
#   theme(legend.position="right") +
#   labs(size="Density, in/sq.miles",
#        color="Party")
# 
# grid.arrange(p1, p2, nrow = 2)
```

<!-- The histogram for enforced mask during holidays might have two populations. States with larger density seem to land in the top right of the scatterplot. A larger amount of republican states seem to not have enforced by citation nor fine the use of face mask. We will not transform this variable either. -->


#### Party Elected in 2020 President Election

```{r party_comparison}
par(mfrow=c(1,2))
# hist(covid_df$party,
#      main = "Party Elected in 2020",
#      xlab = "0: Dem, 1: Rep")
# 
# boxplot(log(covid_deaths_mil)~party, data=covid_df, 
#         xlab="Dem:0, Rep:1",
#         ylab="log Deaths per 100k",
#         main= "Deaths by elected party in 2020")


# party - Election
hist(mothers_df$party,
     main = "States by elected party in 2020",
     xlab = "0: Dem, 1: Rep")

boxplot((covid_deaths_std.m)~party, data=df, 
        xlab="Dem:0, Rep:1",
        ylab="Deaths",
        main= "State party affiliation, \nMother's day")

# boxplot((covid_deaths_std.m)~party, data=df, 
#         xlab="Dem:0, Rep:1",
#         ylab="Deaths per 100k",
#         main= "Mother's day, Med density")
# 
# boxplot(log(covid_deaths_std)~party, data=thanks_df, 
#         xlab="Dem:0, Rep:1",
#         ylab="log Deaths per 100k",
#         main= "Thanksgiving")
```

_Figure 9. (Left) Histogram of state affiliation. Figure 10. (Right) Distribution of death's by party affiliation in 2020 presidential elections._

The histogram shows that the states are almost evenly divided by Republican versus Democrat, where the latter has a minor lead (+1). Democrats have a larger average death toll and a wider distribution compared to Republicans. We also want to point at the impact of high population density may be the reason for such variation (Figure 7) because all the highest population states are democratic.

# Regression Table

### Model 1: Optimized Limited model

To reduce standard errors we modeled the public face mask required variable as a second degree polynomial. We observed that the residuals didn't have a significant deviaiton from zero after the optimization (Figure 11).

$$y = D = \beta_0 + \beta_1M + \beta_2M^2$$

### Model 2: Optimized Extended model

The extended model was optimized by modeling the shelter in place variable as a second degree polynomial, residuals showed a smaller deviation from zero.

$$y = D = \beta_0 +\beta_1M + \beta_2M^2 +\beta_3S +\beta_4S^2 +\beta_5Q$$

### Model 3: Full model 

We kept the model two and added the party affiliation variable as planned.

$$y = D = \beta_0 +\beta_1M + \beta_2M^2 +\beta_3S +\beta_4S^2  +\beta_5Q + \beta_6P$$
After analyzing the variance inflation, we decided to drop the variable shelter in place creating an optimized model three.

$$y = D = \beta_0 +\beta_1M + \beta_2M^2  +\beta_5Q + \beta_6P$$

```{r models}
model_one <- lm(covid_deaths_std ~ 
                  sum_facemask_enforced + I(sum_facemask_enforced^2)
                , data = mothers_df)

model_two <- lm(covid_deaths_std ~ 
                  sum_facemask_enforced + I(sum_facemask_enforced^2) +
                  sum_shelter_in_place + I(sum_shelter_in_place^2) +
                  sum_quarantine_travellers 
                # + sum_holiday_face_mask_citation_fine,
                , data = mothers_df)

model_three <- lm(covid_deaths_std ~ 
                    sum_facemask_enforced + I(sum_facemask_enforced^2) +
                  # sum_shelter_in_place + I(sum_shelter_in_place^2) +
                  sum_quarantine_travellers 
                  # + sum_holiday_face_mask_citation_fine
                  + party,
                data = mothers_df)
```

We present the results of the three models studied.

```{r}
# stargazer example
stargazer(model_one, model_two, model_three,
  type="text",
  se = list(rse(model_one),rse(model_two), rse(model_three)),
column.labels = c("M","M+S+Q","M+Q+P"),
dep.var.labels   = "Death toll per 100k inhabitants",
covariate.labels = c("mask in public", "mask in public sqrd",
                     "shelter in place", "shelter in place sqrd",
                     "quarantine travelers",
                     "party"),
add.lines = list(c("optimized model", "Yes", "Yes","Yes"))
)

```
# Model Limitations

## IID

Each state is geographically dependent of the neighbors and political affiliations. Even when interventions were in place by the government, there is no way to know if the people followed the guidelines en mass. The model hardly complies with this requirement, however we consider for this study that the sample is representative of the USA population at the time period of data collection used in the study and the sample size can be considered not small.

## Linearity

```{r}
# Evaluate for each model and specification
mothers_df <- mothers_df %>%
  mutate(
    predict_model_one = predict(model_one),
    resid_model_one = resid(model_one)
  )

mothers_df <- mothers_df %>%
  mutate(
    predict_model_two = predict(model_two),
    resid_model_two = resid(model_two)
  )

mothers_df <- mothers_df %>%
  mutate(
    predict_model_three = predict(model_three),
    resid_model_three = resid(model_three)
  )
```

For the model one, we have only one specification: mask required in public. We found the residuals had a parabolic trend. For model two we shelter in place residuals were also parabolic. The linearity assumptions was threaten and we optimized the model modeling public face mask and shelter in place as polynomials of second degree. See Figure 11 for model three optimized model plots.

```{r model one residuals}
# mask_resid_m1 <-  mothers_df %>% 
#   ggplot(aes(sum_facemask_enforced, resid_model_one)) + 
#   geom_point() + 
#   stat_smooth() +
#   ggtitle("Reduced model - Specifications vs Residuals") +
#   xlab("days face mask required")
# 
# mask_resid_m1
```



```{r model two spec residuals}
# mask_resid_m2 <-  mothers_df %>% 
#   ggplot(aes(sum_facemask_enforced, resid_model_two)) + 
#   geom_point() + 
#   stat_smooth()
# 
# shelter_resid_m2 <-  mothers_df %>% 
#   ggplot(aes(sum_shelter_in_place, resid_model_two)) + 
#   geom_point() + 
#   stat_smooth()
# 
# quarantine_resid_m2 <-  mothers_df %>% 
#   ggplot(aes(sum_quarantine_travellers, resid_model_two)) + 
#   geom_point() + 
#   stat_smooth()
# 
# # holiday_resid_m2 <-  covid_df %>% 
# #   ggplot(aes(sum_holiday_face_mask_citation_fine, resid_model_two)) + 
# #   geom_point() + 
# #   stat_smooth()
# 
# # party_resid_m2 <-  mothers_df %>%
# #   ggplot(aes(party, resid_model_two)) +
# #   geom_point() +
# #   stat_smooth()
# 
# grid.arrange(mask_resid_m2,
#              shelter_resid_m2,
#              quarantine_resid_m2,
#              # holiday_resid_m2,
#              # party_resid_m2,
#              nrow = 2,
#              top = "Model 2 - Specifications vs Residuals")
```



```{r}
mask_resid_m3 <-  mothers_df %>% 
  ggplot(aes(sum_facemask_enforced, resid_model_three)) + 
  geom_point() + 
  stat_smooth()

shelter_resid_m3 <-  mothers_df %>% 
  ggplot(aes(sum_shelter_in_place, resid_model_three)) + 
  geom_point() + 
  stat_smooth()

quarantine_resid_m3 <-  mothers_df %>% 
  ggplot(aes(sum_quarantine_travellers, resid_model_three)) + 
  geom_point() + 
  stat_smooth()

# holiday_resid_m3 <-  high_d %>% 
#   ggplot(aes(sum_holiday_face_mask_citation_fine, resid_model_three)) + 
#   geom_point() + 
#   stat_smooth()

party_resid_m3 <-  mothers_df %>%
  ggplot(aes(party, resid_model_three)) +
  geom_point() +
  stat_smooth()

grid.arrange(mask_resid_m3,
             shelter_resid_m3,
             quarantine_resid_m3,
             # holiday_resid_m3,
             party_resid_m3,
             nrow = 2,
             top = "Full model - Specifications vs Residuals") 
# +
#   ggtitle("Full model - Specifications vs Residuals")
```

_Figure 11. Specifications vs residuals for optimized model three._

## No perfect collinearity

We know the variables chosen didn't have perfect collinearity because we were able to run the model without singularity problems. Also, we analyzed in the full model which variable is bringing the most inflation to our predictions. Public face mask and shelter in place are both increasing the model variation significantly. We decided to drop shelter in place from model three to optimize the error in the model. We kept public face mask because it's the variable of interest in this study.

```{r vif-coeff}
# vif(model_three)
# coeftest(model_three, vcovHC)
```
After droping the shelter in place specification from model three a slight improvement in the R square adjusted was obtained.

## Homoskedastic errors

It is clear that the model three has a clear deviation from zero when values are small. A similar behavior is seen in the Scale-location plot where the slop dramatically decreases as the values increase, instead of a flat smooth curve. For this reason, the validity of the t-tests and p-values are threatened.

```{r}
par(mfrow=c(1,2))
plot(model_three, which = 1)
plot(model_three, which = 3)
```

_Figure 12. (Left) Residuals vs Fitted for optimized model three show deviation in the middle. Figure 13. (Right) Scale-Log shows a constant increase in the standardized residual values as the fitted value increases._

## Normality of errors

The qq-plot shows that the errors are not normally distributed in both ends of the tail for values less than -1 and 1. The validity of the standard errors reported in this study is threatened.

```{r}

plot_one <- mothers_df %>% 
  ggplot(aes(x = resid_model_three)) + 
  geom_histogram()
  
plot_two <- mothers_df %>% 
  ggplot(aes(sample = resid_model_three)) + 
  stat_qq() + stat_qq_line()

grid.arrange(plot_one, plot_two,
             nrow=1)
```

_Figure 14. (Left) Residuals histogram for model three. Figure 15. (Right) QQ-Plot of residuals of optimized model three._

## zero conditional mean 

The average residual deviates from zero in a parabolic share (Figure 14). Also, we believe that Massachusetts might be an outlier in the data set because of the Cook's D value. We theorize this is due to Massachusetts proximity to New York, which was the epicenter of the pandemic earlier year.

```{r}
plot(model_three, which=4)
```

_Figure 16. Cook's D for optimized model three._

```{r three_hist_plots, fig.height=3, fig.width=10}
# covid_cases <- ggplot(covid_df, aes(x = covid_cases_mil)) +
#   geom_histogram(bins=20, color="darkblue", fill="lightblue") +
#   labs(title="Covid Cases in Millions ",x="covid_cases_mil", y = "Volume")
# facemask_enforced <- ggplot(covid_df, aes(x = sum_facemask_enforced)) +
#   geom_histogram(bins=20, color="darkblue", fill="lightblue") +
#   labs(title="Facemask Enforced",x="sum_facemask_enforced", y = "Volume")
# covid_deaths <- ggplot(covid_df, aes(x = covid_deaths_mil)) +
#   geom_histogram(bins=20, color="darkblue", fill="lightblue") +
#   labs(title="Covid Deaths in Millions",x="covid_deaths_mil", y = "Volume")
# plot_grid(covid_cases, facemask_enforced, covid_deaths, nrow=1)
```

# Discussion of Omitted Variables

We believe that there are multiple factors at play when it comes to considerations around COVID-19 deaths. It is likely that our models are biased due to omitted variables. We listed out those variables as possible limitations to our models. 

**Density per square mile (d)**

We were not able to get accurate current data on the population density for all of the states.  Also, getting the population density of a given state may not give us a true picture of the population density.  For example, majority of the people in Nevada live in the Las Vegas area.  Nevada has a low population density at the state level, but in reality has a much higher population density as the population is concentrated around the city of Las Vegas. Covid-19 infection is spread by close contact with infected people and higher the population density leads to higher rate of infection and death. [6].

D = M, OV=d        D&M (-), D&d(+), M&d(+)  Away from zero, large

**Restaurant occupancy (r)**

Restaurants were closed by mandate inconsistently across states.  Even for those restaurants that were ordered to close, some businesses chose to defy the guidance and opened anyway.  The volume of patrons visiting restaurants during Mother's day, may have influenced the spread and deaths related to Covid-19.

D = M, OV=r       D&M (-), D&e (+), M&r (-) Towards zero, small

**Unemployment (u)**  

The US unemployment rate peaked at 14.8% in April, 2020. [8] Millions of people lost their jobs and were not able to work.  We do not have data on the impact of people not being able to go to work on the Covid-19 infections.  If the umemployed stayed at home, they had the potential of infecting others in the household.  On the other hand, by staying at home, the unemployed had less exposure to Covid-19 compared to physically going to work in an office/restaurant type environment. 

D = M, OV=u   D&M (-), D&u (-), M&u (-) Towards zero, small

**Homelesness (h)**

We do not have data on the homeless population for each state and how they potentially contributed to the spread of Covid-19 infections.  Also, homeless people are less likely to have the resources to purchase masks and other means of protection from Covid-19 infections.  We also do not have the data on location of the homeless population - urban or rural areas.  

D = M, OV=h       D&M (-), D&h (+), D&h (+) Away zero, small

**Covid-19 Fatigue (f)**

While it is difficult to measure Covid-19 fatigue, as the pandemic wore on, people had increased difficulty with social distancing.  People began to weigh mental health impact on isolation vs. the risk of following safety guidelines in favor of ignoring safety guidelines.  We saw evidence of this from people gathering for spring break and end of year holidays such as Thanksgiving and Christmas.


D = M, OV=f       D&M (-), D&f (+), M&f (+) Away zero, large

```{r}
raw_info4<- data.frame(
  OV = c("Density per square mile",
           "Restaurant occupancy",
           "Unemployment",
           "Homelessness",
           "Covid-19 Fatigue"),
  Bias = c("Away from zero",
                  "Toward zero",
                  "Toward zero",
                  "Away from zero",
                  "Away from zero"),
  Effect_size = c("Large", 
             "Small",
             "Small",
             "Small",
             "Large")
)

kable(raw_info4, caption="Table 3. Omitted variable bias for optimized model three.")
```



# Conclusion

After evaluating three models and optimized them to comply with the classical linear model assumptions, we found the model three was the best. The optimized model three used only data from mother's day (+/- 15 days), a time relatively early in the pandemic when guidelines in multiple states were in place and people were heeding the guidelines.

The optimized model three considered public face mask mandate, quarantine for travelers and the affiliated party during the presidential election as covariates. We encountered threats to validity of the standard error, F-test, t-value and p-value due to homoskedastic error and fail to comply with normality of errors. The results of this study will focus only in the coefficients of the input variables of the optimized model three.

$$y = D = 11.51 -0.22\cdot M_d + 0.04 \cdot M_d^2  -0.13 \cdot Q_d -5.92 \cdot P_d \qquad (1)$$

We found a negative correlation between deaths and public face mask, quarantine for travelers and the state's political affiliation. This relationship matched our initial theory.

Based on equation one, we can see that over a thirty day period, a maximum of six lives were saved per hundred thousand people in the states that had a public mask mandate in effect during Mother's day. Quarantine for travelers saves approximately three lives per hundred thousand. The political affiliation of the state based on 2020 presidential elections had a negative correlation with deaths. If the state was Republican, an estimated of 6 lives were saved per hundred thousand people. We found this effect may be influenced due to low population density in republican states. Highest population density states were largely democratic (see Figure 6).

Having said that, we must emphasize that our optimized model three is not a good estimator for deaths. The R square adjusted is low, with a value of 0.57, meaning that there's a large amount of variation not explained by our model.
  


# References

[1] Dong E, Du H, Gardner L. An interactive web-based dashboard to track COVID-19 in real time. Lancet Inf Dis. 20(5):533-534. doi: 10.1016/S1473-3099(20)30120-1

[2] Feng et al. (2020, March). Rational use of face masks in the COVID-19 pandemic. Retrieved April 05, 2021, from https://www.thelancet.com/journals/lanres/article/PIIS2213-2600(20)30134-X/fulltext

[3] https://time.com/5915084/hawaii-covid-coronavirus/

[4] https://www.bloomberg.com/news/articles/2021-01-06/n-y-s-neighbor-keeps-cases-lowest-in-u-s-throughout-pandemic

[5] https://www.wweek.com/news/2020/12/23/oregon-fares-better-than-nearly-all-states-by-two-key-covid-19-measures/

[6] https://www.cdc.gov/coronavirus/2019-ncov/prevent-getting-sick/how-covid-spreads.html
[7] http://electionlab.mit.edu/sites/default/files/2020-12/How-we-voted-in-2020-v01.pdf
[8] https://fas.org/sgp/crs/misc/R46554.pdf

[9] https://www.nytimes.com/2020/04/24/us/coronavirus-new-mexico.html

[10] https://www.npr.org/2020/10/24/927384374/rural-midwestern-communities-hit-hard-as-coronavirus-surges-in-u-s-again